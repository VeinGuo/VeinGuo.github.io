<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS常用数据持久化 · Vein</title><meta name="description" content="iOS常用数据持久化 - Vein"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://github.com/VeinGuo/atom.xml" title="Vein"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/woshirucichenlun" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/VeinGuo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS常用数据持久化</h1><div class="post-info">Nov 28, 2016</div><div class="post-content"><p>数据层一直是程序的核心结构之一，在iOS开发过程中通常需要对数据进行持久化缓存以保证在无网络情况下打开App后进行一些展示或缓存聊天记录等，这时候就需要持久化数据。</p>
<h2 id="什么是数据持久化"><a href="#什么是数据持久化" class="headerlink" title="什么是数据持久化"></a>什么是数据持久化</h2><p>数据持久化就是将内存中的数据模型转换为存储模型,以及将存储模型转换为内存中的数据模型的统称. 数据模型可以是任何数据结构或对象模型,存储模型可以是关系模型、XML、二进制流等。cmp和Hibernate只是对象模型到关系模型之间转换的不同实现。</p>
<h2 id="常用的数据持久化"><a href="#常用的数据持久化" class="headerlink" title="常用的数据持久化"></a>常用的数据持久化</h2><p>在项目开发中我最常使用的持久化方式有：</p>
<ul>
<li>NSUserDefault</li>
<li>Plist文件存储 </li>
<li>NSKeyedArchiver 归档</li>
<li>SQLite3(数据库)</li>
</ul>
<a id="more"></a>
<h3 id="NSFileManager"><a href="#NSFileManager" class="headerlink" title="NSFileManager"></a>NSFileManager</h3><p>Plist 和 归档 使用文件操作存储需要用到NSFileManager，创建一个工具类来对App的文件进行</p>
<p>NSFileManager 是处理文件系统的 Foundation 框架的高级API。它抽象了 Unix 和 Finder 的内部构成，和 iCloud ubiquitous containers 一样， 提供了创建，读取，移动，拷贝以及删除本地或者网络驱动器上的文件或者目录的方法。</p>
<p>NSFileManager 是一个单例使用以下方法来获得</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"> + (<span class="built_in">NSFileManager</span> *)defaultManager</div></pre></td></tr></table></figure>
<p>NSFileManager常用方法就不多提了这里需要提的一点是线程注意。<br>apple 中提到：</p>
<h4 id="Threading-Considerations"><a href="#Threading-Considerations" class="headerlink" title="Threading Considerations"></a>Threading Considerations</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">The methods of the shared NSFileManager object can be called from multiple threads safely. However, if you use a delegate to receive notifications about the status of move, copy, remove, and link operations, you should create a unique instance of the file manager object, assign your delegate to that object, and use that file manager to initiate your operations.</div></pre></td></tr></table></figure>
<p>大概说一下意思就是共享的NSFileManager对象方法可以从多个线程调用是安全的。可是，如果使用委托通知的状态移动，复制，删除等等操作，应该创建一个唯一实例并使用该实例来开始你的操作。</p>
<p>如使用NSFileManagerDelegate时最好创建实例来进行操作</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSFileManager</span> *fileManager = [[<span class="built_in">NSFileManager</span> alloc] init];</div><div class="line">fileManager.delegate = delegate;</div><div class="line"></div><div class="line"><span class="built_in">NSURL</span> *bundleURL = [[<span class="built_in">NSBundle</span> mainBundle] bundleURL];</div><div class="line"><span class="built_in">NSArray</span> *contents = [fileManager contentsOfDirectoryAtURL:bundleURL</div><div class="line">                               includingPropertiesForKeys:@[]</div><div class="line">                               options:<span class="built_in">NSDirectoryEnumerationSkipsHiddenFiles</span> </div><div class="line">                               error:<span class="literal">nil</span>];</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *filePath <span class="keyword">in</span> contents) &#123;</div><div class="line">    [fileManager removeItemAtPath:filePath error:<span class="literal">nil</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是我开发中一些常用的文件操作方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建一个存储文件夹并获取路径</span></div><div class="line">+ (<span class="built_in">NSString</span> *)getDocumentPath</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> *documentPath = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        <span class="built_in">NSArray</span> *paths = <span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>);</div><div class="line">        documentPath = [[<span class="built_in">NSString</span> alloc]initWithFormat:<span class="string">@"%@/%@/"</span>,[paths objectAtIndex:<span class="number">0</span>],FOLDER_FILE_NAME];</div><div class="line">        <span class="keyword">if</span> (![[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:documentPath])</div><div class="line">        &#123;</div><div class="line">            [[<span class="built_in">NSFileManager</span> defaultManager] createDirectoryAtPath:documentPath</div><div class="line">                                      withIntermediateDirectories:<span class="literal">NO</span></div><div class="line">                                                       attributes:<span class="literal">nil</span></div><div class="line">                                                            error:<span class="literal">nil</span>];</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> documentPath;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 文件大小</span></div><div class="line">+ (<span class="built_in">NSUInteger</span>)getFileSizeAtFileName:(<span class="built_in">NSString</span>*)fileName&#123;</div><div class="line">  <span class="built_in">NSString</span> *path = [[VGFileManagerCommon getDocumentPath] stringByAppendingPathComponent:fileName];</div><div class="line">    <span class="keyword">return</span> [[[<span class="built_in">NSFileManager</span> defaultManager] attributesOfItemAtPath:path error:<span class="literal">nil</span>]fileSize];</div><div class="line">&#125;</div><div class="line"><span class="comment">// 文件是否存在</span></div><div class="line">+ (<span class="built_in">BOOL</span>)isFileExistAtPath:(<span class="built_in">NSString</span>*)filePath</div><div class="line">&#123;</div><div class="line">    <span class="built_in">BOOL</span> isExist = <span class="literal">NO</span>;</div><div class="line">    isExist = [[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:filePath];</div><div class="line">    <span class="keyword">return</span> isExist;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 文件是否存在</span></div><div class="line">+ (<span class="built_in">BOOL</span>)isFileExistAtFileName:(<span class="built_in">NSString</span>*)fileName</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *path = [[VGFileManagerCommon getDocumentPath] stringByAppendingPathComponent:fileName];</div><div class="line">    <span class="keyword">return</span> [VGFileManagerCommon isFileExistAtPath:path];</div><div class="line">&#125;</div><div class="line"><span class="comment">// 删除文件</span></div><div class="line">+ (<span class="built_in">BOOL</span>)deleteFileAtFileName:(<span class="built_in">NSString</span> *)fileName</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSFileManager</span>   *fileMgr = [<span class="built_in">NSFileManager</span> defaultManager];</div><div class="line">    <span class="built_in">NSString</span> *deletePath = [[VGFileManagerCommon getDocumentPath] stringByAppendingPathComponent:fileName];</div><div class="line">    <span class="built_in">NSError</span> *err = <span class="literal">nil</span>;</div><div class="line">    [fileMgr removeItemAtPath:deletePath error:&amp;err];</div><div class="line">    <span class="keyword">return</span> err != <span class="literal">nil</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="NSUserDefault"><a href="#NSUserDefault" class="headerlink" title="NSUserDefault"></a>NSUserDefault</h3><p>常用来存储一个简单的状态如是否第一次登陆</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSUserDefaults</span> *userDefaults = [<span class="built_in">NSUserDefaults</span> standardUserDefaults];</div><div class="line">[userDefaults setBool:<span class="literal">YES</span> forKey:<span class="string">@"firstLogin"</span>];</div><div class="line">[userDefaults synchronize];</div></pre></td></tr></table></figure>
<h3 id="Plist文件存储"><a href="#Plist文件存储" class="headerlink" title="Plist文件存储"></a>Plist文件存储</h3><p>Property List，属性列表文件，它是一种用来存储串行化后的对象的文件。属性列表文件的扩展名为.plist ，plist文件的实质为XML文件。</p>
<p>可以被序列化的类型只有如下几种：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSArray</span> </div><div class="line"><span class="built_in">NSMutableArray</span></div><div class="line"><span class="built_in">NSDictionary</span> </div><div class="line"><span class="built_in">NSMutableDictionary</span></div><div class="line"><span class="built_in">NSData</span> </div><div class="line"><span class="built_in">NSMutableData</span></div><div class="line"><span class="built_in">NSString</span> </div><div class="line"><span class="built_in">NSMutableString</span></div><div class="line"><span class="built_in">NSNumber</span></div><div class="line"><span class="built_in">NSDate</span></div></pre></td></tr></table></figure>
<p>在实际的开发中我一般存储NSArray和NSDictonary<br>经过使用后建议使用JSON 存储 取出后转成模型，避免增减字段的问题</p>
<p>开发中例子</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)fetchItemsWithCompletion:(VGPlistStoreFetchCompletionHandler)completion&#123;</div><div class="line">    <span class="built_in">NSDictionary</span> *cacheJson = [<span class="keyword">self</span> loadCache];</div><div class="line">    <span class="keyword">if</span> (completion) &#123;</div><div class="line">        completion(cacheJson);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSDictionary</span> *)loadCache</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *path = [<span class="keyword">self</span> savePath];</div><div class="line">    <span class="keyword">if</span> ([VGFileManagerCommon isFileExistAtPath:path]) &#123;</div><div class="line">        <span class="keyword">return</span> [<span class="built_in">NSDictionary</span> dictionaryWithContentsOfFile:path];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span> *)savePath</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [[VGFileManagerCommon getDocumentPath] stringByAppendingPathComponent:<span class="string">@"cache.plist"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)saveJSON:(<span class="built_in">NSDictionary</span> *)json</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (json) &#123;</div><div class="line">        <span class="built_in">NSString</span> *path = [<span class="keyword">self</span> savePath];</div><div class="line">        [json writeToFile:path atomically:<span class="literal">YES</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="NSKeyedArchiver-归档"><a href="#NSKeyedArchiver-归档" class="headerlink" title="NSKeyedArchiver 归档"></a>NSKeyedArchiver 归档</h3><p>归档只要遵循了NSCoding协议的对象都可以通过它实现序列化。<br>平时项目中使用Mantle 来实现model层 Mantle已经实现了NSCoding协议</p>
<p>Demo中例子直接存储model 但建议还是把Model转换成JSON Dictionary 来存储load时再转换成model</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">+ (<span class="keyword">instancetype</span>)store</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] init];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)fetchItemsWithCompletion:(VGKeyedArchiverStoreFetchCompletionHandler)completion</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> ([VGFileManagerCommon isFileExistAtPath:[<span class="keyword">self</span> savePath]]) &#123;</div><div class="line">        VGCacheModel *model = [<span class="keyword">self</span> loadModel];</div><div class="line">        completion(model);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (VGCacheModel *)loadModel</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithFile:[<span class="keyword">self</span> savePath]];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span> *)savePath</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *path = <span class="string">@"keyedArchiverStore.bin"</span>;</div><div class="line">    <span class="keyword">return</span> [[VGFileManagerCommon getDocumentPath] stringByAppendingPathComponent:path];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)saveModel:(VGCacheModel *)Model</div><div class="line">&#123;</div><div class="line">    <span class="built_in">BOOL</span> success = [<span class="built_in">NSKeyedArchiver</span> archiveRootObject:Model toFile:[<span class="keyword">self</span> savePath]];</div><div class="line">    <span class="keyword">if</span> (!success) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Save Failed"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SQLite3-数据库"><a href="#SQLite3-数据库" class="headerlink" title="SQLite3(数据库)"></a>SQLite3(数据库)</h3><p>一般用来存储大量的内容并可单一的修改更新某一条缓存信息等。实际上SQLite是无类型的。即不管你在创表时指定的字段类型是什么，存储是依然可以存储任意类型的数据。而且在创表时也可以不指定字段类型。</p>
<p>开发中我一般使用FMDB第三方库来进行数据库操作，demo中例子就使用FMDB实现。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建数据库</span></div><div class="line">- (<span class="keyword">void</span>)openDatabase</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *filepath = [[VGFileManagerCommon getDocumentPath] stringByAppendingString:<span class="string">@"cache.db"</span>];</div><div class="line">    FMDatabase *db = [FMDatabase databaseWithPath:filepath];</div><div class="line">    <span class="keyword">if</span> ([db open])</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">self</span>.db = db;</div><div class="line">        <span class="built_in">NSString</span> *sql = <span class="string">@"CREATE TABLE IF NOT EXISTS CACHE \</span></div><div class="line">        (uid INTEGER PRIMARY KEY, \</div><div class="line">        url TEXT, \</div><div class="line">        title TEXT)";</div><div class="line">        <span class="keyword">if</span> (![<span class="keyword">self</span>.db executeUpdate:sql])</div><div class="line">        &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"execute sql %@ error %@"</span>,sql,<span class="keyword">self</span>.db.lastError);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"open database failed %@"</span>,filepath);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#pragma mark - public</span></div><div class="line"></div><div class="line">- (<span class="built_in">NSArray</span> &lt;VGCacheModel *&gt;*)fetchCacheModelWithLimit:(<span class="built_in">NSInteger</span>)limit&#123;</div><div class="line">    __block <span class="built_in">NSArray</span> *result = <span class="literal">nil</span>;</div><div class="line">    <span class="built_in">NSString</span> *sql = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">if</span> (limit) &#123;</div><div class="line">        sql = <span class="string">@"SELECT *FROM CACHE ORDER BY uid DESC LIMIT ?"</span>;</div><div class="line">    &#125;</div><div class="line">    db_sync_safe(^&#123;</div><div class="line">        <span class="built_in">NSMutableArray</span> &lt;VGCacheModel *&gt;*array = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">        FMResultSet *rs = [<span class="keyword">self</span>.db executeQuery:sql, @(limit)];</div><div class="line">        <span class="keyword">while</span> ([rs next]) &#123;</div><div class="line">            VGCacheModel *model = loadToDatabase(rs);</div><div class="line">            [array addObject:model];</div><div class="line">        &#125;</div><div class="line">        [rs close];</div><div class="line">        result = array;</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)saveModels:(<span class="built_in">NSArray</span> &lt;VGCacheModel *&gt;*)models&#123;</div><div class="line">    db_sync_safe(^&#123;</div><div class="line">        <span class="keyword">if</span> ([models count]) &#123;</div><div class="line">            [<span class="keyword">self</span>.db beginTransaction];</div><div class="line">            <span class="keyword">for</span> (VGCacheModel*model <span class="keyword">in</span> models) &#123;</div><div class="line">                saveToDatabase(<span class="keyword">self</span>.db, model);</div><div class="line">            &#125;</div><div class="line">            [<span class="keyword">self</span>.db commit];</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)updateModel:(VGCacheModel *)model&#123;</div><div class="line">    <span class="built_in">NSString</span> *sql = <span class="string">@"UPDATE CACHE SET TITLE = ? WHRER uid = ?"</span>;</div><div class="line">    db_async(^&#123;</div><div class="line">        <span class="keyword">if</span> (![<span class="keyword">self</span>.db executeUpdate:sql, model.title, model.uid]) &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"update failed sql %@"</span>,sql);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#pragma mark - save &amp; load</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> VGCacheModel * loadToDatabase(FMResultSet *resultSet)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSInteger</span> uid = [resultSet longLongIntForColumn:<span class="string">@"uid"</span>];</div><div class="line">    <span class="built_in">NSString</span> *URL = [resultSet stringForColumn:<span class="string">@"url"</span>];</div><div class="line">    <span class="built_in">NSString</span> *title = [resultSet stringForColumn:<span class="string">@"title"</span>];</div><div class="line">    </div><div class="line">    VGCacheModel *model = [[VGCacheModel alloc] init];</div><div class="line">    model.uid = uid;</div><div class="line">    model.imageURL = URL;</div><div class="line">    model.title = title;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> model;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> saveToDatabase(FMDatabase *db, VGCacheModel *model)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *sql = <span class="string">@"INSERT OR REPLACE INTO CACHE(uid, url, title) VALUES(?,?,?)"</span>;</div><div class="line">    <span class="keyword">if</span>(![db executeUpdate:sql,</div><div class="line">        @(model.uid),</div><div class="line">        model.imageURL,</div><div class="line">        model.title])&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"update failed sql %@"</span>,sql);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#pragma mark - Queue</span></div><div class="line"><span class="built_in">dispatch_queue_t</span> cacheDatabaseQueue()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_queue_t</span> queue;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        queue = dispatch_queue_create(databaseQueue, <span class="number">0</span>);</div><div class="line">        dispatch_queue_set_specific(queue, kDatabaseQueueSpecificKey, (<span class="keyword">void</span> *)kDatabaseQueueSpecificKey, <span class="literal">NULL</span>);</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> queue;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^dispatch_block)(<span class="keyword">void</span>);</div><div class="line"><span class="keyword">void</span> db_sync_safe(dispatch_block block)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (dispatch_get_specific(kDatabaseQueueSpecificKey))</div><div class="line">    &#123;</div><div class="line">        block();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        <span class="built_in">dispatch_sync</span>(cacheDatabaseQueue(), ^() &#123;</div><div class="line">            block();</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> db_async(dispatch_block block)&#123;</div><div class="line">    <span class="built_in">dispatch_async</span>(cacheDatabaseQueue(), ^() &#123;</div><div class="line">        block();</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h2><p>文章中例子的完整代码<br>Demo简单的实现了Plist、NSKeyedArchiver 归档、SQLite3(数据库) 三种数据持久化<br><a href="https://github.com/VeinGuo/VGCacheDemo.git">VGCacheDemo</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://nshipster.com/nsfilemanager/" target="_blank" rel="external">NSHipster NSFileManager</a></li>
<li><a href="http://www.jianshu.com/p/119fb5bdf30a" target="_blank" rel="external">iOS中的数据持久化</a></li>
<li><a href="http://www.jianshu.com/p/7616cbd72845" target="_blank" rel="external">我要永远地记住你！(iOS中几种数据持久化方案)</a></li>
</ul>
<p>&lt;!— more –&gt;</p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/12/07/Block是如何实现？/" class="prev">PREV</a><a href="/2016/09/29/Learn Swift - 2 Tuple(元组)/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'gwrcode';
var disqus_identifier = '2016/11/28/iOS常用数据持久化/';
var disqus_title = 'iOS常用数据持久化';
var disqus_url = 'https://github.com/VeinGuo/2016/11/28/iOS常用数据持久化/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//gwrcode.disqus.com/count.js" async></script><div class="copyright"><p>© 2016 - 2017 <a href="https://github.com/VeinGuo">Vein</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-90661596-1",'auto');ga('send','pageview');</script></body></html>