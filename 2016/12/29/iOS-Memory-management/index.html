<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS Memory management Â· Vein</title><meta name="description" content="iOS Memory management - Vein"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://github.com/VeinGuo/atom.xml" title="Vein"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/woshirucichenlun" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/VeinGuo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS Memory management</h1><div class="post-info">Dec 29, 2016</div><div class="post-content"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="# å‰è¨€"></a># å‰è¨€</h2><blockquote>
<p>åå¤åœ°å¤ä¹ iOSåŸºç¡€çŸ¥è¯†å’ŒåŸç†ï¼Œæ‰“ç£¨çŸ¥è¯†ä½“ç³»æ˜¯éå¸¸é‡è¦çš„ï¼Œæœ¬ç¯‡å°±æ˜¯é‡æ–°æ¸©ä¹ iOSçš„å†…å­˜ç®¡ç†ã€‚</p>
</blockquote>
<p>å†…å­˜ç®¡ç†æ˜¯ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸï¼Œåœ¨å¯¹è±¡ä¸éœ€è¦æ—¶è¿›è¡Œå†…å­˜é‡Šæ”¾çš„ç¼–ç¨‹è§„èŒƒã€‚</p>
<h2 id="MRRæ—¶ä»£"><a href="#MRRæ—¶ä»£" class="headerlink" title="# MRRæ—¶ä»£"></a># MRRæ—¶ä»£</h2><h3 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h3><p>Objective-Cå†…å­˜ç®¡ç†ä½¿ç”¨ä½¿ç”¨å¼•ç”¨è®¡æ•°(Reference Counting)æ¥ç®¡ç†å†…å­˜ã€‚</p>
<blockquote>
<p>åœ¨OS X 10.8ä»¥åä¹Ÿä¸å†ä½¿ç”¨åƒåœ¾å›æ”¶æœºåˆ¶ï¼ŒiOSåˆ™ä»æ¥éƒ½æ²¡æœ‰æ”¯æŒåƒåœ¾å›æ”¶æœºåˆ¶ã€‚</p>
</blockquote>
<p>å½“<code>create</code>æˆ–è€…<code>copy</code>å¯¹è±¡æ—¶ï¼Œä¼šè®¡æ•°ä¸º1ï¼Œå…¶ä»–å¯¹è±¡éœ€è¦<code>retain</code>æ—¶ï¼Œä¼šå¢åŠ å¼•ç”¨è®¡æ•°ã€‚æŒæœ‰å¯¹è±¡çš„æ‰€æœ‰è€…ä¹Ÿå¯ä»¥æ”¾å¼ƒæ‰€æœ‰æƒï¼Œæ”¾å¼ƒæ‰€æœ‰æƒæ—¶å‡å°‘è®¡æ•°ï¼Œå½“è®¡æ•°ä¸º0æ—¶å°±ä¼šé‡Šæ”¾å¯¹è±¡ã€‚<br>å¦‚å›¾ï¼š</p>
<p><img src="http://ojaltanzc.bkt.clouddn.com/2016-12-29-memory-management/memory_management_2x.png" alt="memory_management"><br><a id="more"></a></p>
<h4 id="Memory-Management-Policy-å†…å­˜ç®¡ç†ç­–ç•¥"><a href="#Memory-Management-Policy-å†…å­˜ç®¡ç†ç­–ç•¥" class="headerlink" title="Memory Management Policy å†…å­˜ç®¡ç†ç­–ç•¥"></a>Memory Management Policy å†…å­˜ç®¡ç†ç­–ç•¥</h4><ul>
<li>é€šè¿‡åˆ†é…å†…å­˜æˆ–<code>copy</code>æ¥åˆ›å»ºä»»ä½•å¯¹è±¡</li>
<li>ä½¿ç”¨æ–¹æ³• <code>alloc</code>, <code>allocWithZone:</code>, <code>copy</code>, <code>copyWithZone:</code>, <code>mutableCopy</code> , <code>mutableCopyWithZone:</code>åˆ›å»ºå¯¹è±¡</li>
<li>é€šè¿‡<code>retain</code>æ¥è·å–ä¸æ˜¯è‡ªå·±åˆ›å»ºå¯¹è±¡çš„æ‰€æœ‰æƒã€‚ä»¥ä¸‹ä¸¤ç§æƒ…å†µä½¿ç”¨<code>retain</code>:<ol>
<li>åœ¨<code>accessor method</code>æˆ–è€…<code>init method</code>æ–¹æ³•è·å–æ‰€éœ€è¦çš„å¯¹è±¡æ‰€æœ‰æƒä¸ºå±æ€§<code>property</code> ã€‚</li>
<li>éœ€è¦æ“ä½œå¯¹è±¡æ—¶ï¼Œé¿å…å¯¹è±¡è¢«é‡Šæ”¾è€Œå¯¼è‡´é”™è¯¯ï¼Œéœ€è¦<code>retain</code>æŒæœ‰å¯¹è±¡ã€‚</li>
</ol>
</li>
<li>å‘é€<code>release</code>, <code>autorelease</code>æ¶ˆæ¯æ¥é‡Šæ”¾ä¸éœ€è¦çš„å¯¹è±¡ã€‚</li>
<li>ä¸è¦ä¸æ˜¯ä½ åˆ›å»ºçš„å¯¹è±¡å’Œæ²¡æœ‰æ‰€æœ‰æƒçš„å¯¹è±¡å‘é€<code>release</code>æ¶ˆæ¯ã€‚</li>
</ul>
<h4 id="Practical-Memory-Management-å®é™…å†…å­˜ç®¡ç†"><a href="#Practical-Memory-Management-å®é™…å†…å­˜ç®¡ç†" class="headerlink" title="Practical Memory Management å®é™…å†…å­˜ç®¡ç†"></a>Practical Memory Management å®é™…å†…å­˜ç®¡ç†</h4><ul>
<li><p>Autorelease pools</p>
<ul>
<li>å‘å¯¹è±¡å‘é€<code>autorelease</code>æ¶ˆæ¯ï¼Œä¼šå°†å¯¹è±¡æ ‡è®°ä¸ºå»¶è¿Ÿé‡Šæ”¾ï¼Œå½“å¯¹è±¡è¶…å‡ºå½“å‰ä½œç”¨åŸŸæ—¶ï¼Œé‡Šæ”¾å¯¹è±¡ã€‚</li>
<li><p><code>AppKit frameworks</code>å’Œ<code>UIKit frameworks</code>åœ¨äº‹ä»¶å¾ªç¯çš„æ¯ä¸ªå‘¨æœŸå¼€å§‹æ—¶ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸Šåˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå¹¶åœ¨æ­¤æ¬¡æ—¶é—´å¾ªç¯ç»“æŸæ—¶ï¼Œé‡Šæ”¾å®ƒï¼Œä»è€Œé‡Šæ”¾åœ¨å¤„ç†æ—¶ç”Ÿæˆçš„æ‰€æœ‰è‡ªåŠ¨é‡Šæ”¾çš„å¯¹è±¡ã€‚å› æ­¤ï¼Œé€šå¸¸ä¸éœ€è¦è‡ªå·±åˆ›å»º<code>autoreleasePool</code>ï¼Œå½“ç„¶ï¼Œä»¥ä¸‹æƒ…å†µä½ éœ€è¦è‡ªå·±åˆ›å»ºå’Œé”€æ¯<code>autoreleasePool</code>ï¼š</p>
<ol>
<li>å¦‚æœä½ ç¼–å†™çš„ä»£ç ä¸æ˜¯åŸºäº<code>UI framework</code>çš„ç¨‹åºï¼Œå¦‚<code>command-line tool</code>å‘½ä»¤è¡Œå·¥å…·ã€‚</li>
<li>å¦‚æœä½ éœ€è¦å†™ä¸€ä¸ªå¾ªç¯ï¼Œåˆ›å»ºè®¸å¤šä¸´æ—¶å¯¹è±¡ï¼Œå¦‚è¯»å…¥å¤§é‡çš„é“œåƒåŒæ—¶æ”¹å˜å›¾ç‰‡å°ºå¯¸ï¼Œå›¾åƒè¯»å…¥åˆ°<code>NSData</code>å¯¹è±¡ï¼Œå¹¶ä»ä¸­ç”Ÿæˆ<code>UIImage</code>å¯¹è±¡ï¼Œæ”¹å˜è¯¥å¯¹è±¡å°ºå¯¸ç”Ÿæˆæ–°çš„<code>UIImage</code>å¯¹è±¡ã€‚</li>
<li>å¦‚æœä½ åˆ›å»ºä¸€ä¸ªé•¿æœŸå­˜åœ¨çº¿ç¨‹å¹¶ä¸”å¯èƒ½äº§ç”Ÿå¤§é‡çš„<code>autorelease</code>å¯¹è±¡ã€‚</li>
</ol>
</li>
</ul>
</li>
<li><p><code>autoreleasePool</code>æ¨èä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">	<span class="comment">//do something</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>dealloc</p>
</li>
<li><p>å½“<code>NSObject</code>å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œé”€æ¯è¯¥å¯¹è±¡å‰ä¼šè°ƒç”¨<code>dealloc</code>æ–¹æ³•ï¼Œç”¨æ¥é‡Šæ”¾è¯¥å¯¹è±¡æ‹¥æœ‰çš„æ‰€æœ‰èµ„æºï¼ŒåŒ…è£¹å®ä¾‹å˜é‡æŒ‡å‘çš„å¯¹è±¡ã€‚<br>  ä¾‹å­:</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//	MRR</span></div><div class="line">- (<span class="keyword">void</span>)dealloc&#123;</div><div class="line">   [_firstName release];</div><div class="line">   [_lastName release];</div><div class="line">   [<span class="keyword">super</span> dealloc];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Important: Never invoke another objectâ€™s dealloc method directly.You must invoke the superclassâ€™s implementation at the end of your implementation.You should not tie management of system resources to object lifetimes; see Donâ€™t Use dealloc to Manage Scarce Resources.When an application terminates, objects may not be sent a dealloc message. Because the processâ€™s memory is automatically cleared on exit, it is more efficient simply to allow the operating system to clean up resources than to invoke all the memory management methods.<br>ä¸è¦ç›´æ¥è°ƒç”¨å¦ä¸€ä¸ªå¯¹è±¡çš„deallocæ–¹æ³•ã€‚<br>ä½ å¿…é¡»åœ¨ç±»ä½¿ç”¨ç»“æŸæ—¶è°ƒç”¨çˆ¶ç±»çš„å®ç°ã€‚<br>ä½ ä¸åº”è¯¥æŠŠç³»ç»Ÿèµ„æºä¸å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šã€‚<br>å› ä¸ºè¿›ç¨‹çš„å†…å­˜é€€å‡ºæ—¶ï¼Œå¯¹è±¡å¯èƒ½æ— æ³•å‘é€deallocæ¶ˆæ¯,è¯¥æ–¹æ³•çš„å†…å­˜è¢«è‡ªåŠ¨é€€å‡ºæ¸…é›¶,æ‰€ä»¥è®©æ“ä½œç³»ç»Ÿæ¸…ç†èµ„æºæ¯”è°ƒç”¨æ‰€æœ‰çš„å†…å­˜ç®¡ç†æ–¹æ³•æ›´æœ‰æ•ˆã€‚</p>
</blockquote>
<h3 id="å†…å­˜ç®¡ç†å®è·µ"><a href="#å†…å­˜ç®¡ç†å®è·µ" class="headerlink" title="å†…å­˜ç®¡ç†å®è·µ"></a>å†…å­˜ç®¡ç†å®è·µ</h3><h4 id="ä½¿ç”¨è®¿é—®å™¨æ–¹æ³•ä½¿å†…å­˜ç®¡ç†æ›´è½»æ¾"><a href="#ä½¿ç”¨è®¿é—®å™¨æ–¹æ³•ä½¿å†…å­˜ç®¡ç†æ›´è½»æ¾" class="headerlink" title="ä½¿ç”¨è®¿é—®å™¨æ–¹æ³•ä½¿å†…å­˜ç®¡ç†æ›´è½»æ¾"></a>ä½¿ç”¨è®¿é—®å™¨æ–¹æ³•ä½¿å†…å­˜ç®¡ç†æ›´è½»æ¾</h4><blockquote>
<p>å¦‚æœç±»æœ‰ä¸€ä¸ªå±æ€§æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä½ å¿…é¡»ç¡®ä¿ä½¿ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œå®ƒä¸ä¼šè¢«é‡Šæ”¾ã€‚å› æ­¤åœ¨è®¾ç½®æ—¶ï¼Œå¿…é¡»å£°æ˜å¯¹è±¡çš„æ‰€æœ‰æƒã€‚è¿˜å¿…é¡»ä¿è¯æŒæœ‰è¿™äº›å¯¹è±¡æ‰€æœ‰æƒçš„æ”¾å¼ƒã€‚</p>
</blockquote>
<ul>
<li>ä½¿ç”¨<code>set</code>å’Œ<code>get</code>æ–¹æ³•æ¥å®ç°ï¼Œæ›´æ–¹ä¾¿ç®¡ç†å†…å­˜ï¼ˆä¸»è¦æ˜¯çœå†™å¾ˆå¤š<code>retain</code>å’Œ<code>release</code>ï¼‰ã€‚<br>ä¾‹å­å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Counter</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">retain</span>) <span class="built_in">NSNumber</span> *count;</div><div class="line"><span class="keyword">@end</span>;</div></pre></td></tr></table></figure>
<p><code>Counter</code>ç±»æœ‰ä¸€ä¸ªå±æ€§æ˜¯<code>NSNumber</code>å¯¹è±¡ï¼Œå±æ€§å£°æ˜äº†<code>set</code>å’Œ<code>get</code>ä¸¤ä¸ªè®¿é—®å™¨æ–¹æ³•ï¼Œåœ¨<code>get</code>ä¸­å°±æ˜¯è¿”å›<code>synthesized</code>å®ä¾‹å˜é‡ï¼Œæ‰€ä»¥æ²¡å¿…è¦<code>retain</code>æˆ–è€…<code>release</code>ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSNumber</span> *)count &#123;</div><div class="line">	<span class="keyword">return</span> _count;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>set</code>æ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setCount:(<span class="built_in">NSNumber</span> *)newCount &#123;</div><div class="line">    [newCount <span class="keyword">retain</span>]; <span class="comment">// å…ˆ`retain`ç¡®ä¿æ–°æ•°æ®ä¸è¢«é‡Šæ”¾</span></div><div class="line">    [_count release];  <span class="comment">// é‡Šæ”¾æ—§å¯¹è±¡æ‰€æœ‰æƒ</span></div><div class="line">    <span class="comment">// Make the new assignment.</span></div><div class="line">    _count = newCount; 	<span class="comment">// å°†æ–°å€¼èµ‹ç»™_count</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…ˆ<code>retain</code>ç¡®ä¿æ–°æ•°æ®ä¸è¢«é‡Šæ”¾ï¼Œé‡Šæ”¾æ—§çš„å¯¹è±¡æ‰€æœ‰æƒ(Objective-Cå…è®¸å‘<code>nil</code>å‘é€æ¶ˆæ¯)ã€‚ä½ å¿…é¡»åœ¨<code>[newCount retain]</code>ä¹‹åå†<code>[_count release]</code>ç¡®ä¿å¤–éƒ¨ä¸ä¼šè¢«<code>dealloc</code>ã€‚</p>
<h4 id="ä½¿ç”¨è®¿é—®å™¨æ–¹æ³•è®¾ç½®å±æ€§"><a href="#ä½¿ç”¨è®¿é—®å™¨æ–¹æ³•è®¾ç½®å±æ€§" class="headerlink" title="ä½¿ç”¨è®¿é—®å™¨æ–¹æ³•è®¾ç½®å±æ€§"></a>ä½¿ç”¨è®¿é—®å™¨æ–¹æ³•è®¾ç½®å±æ€§</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ–¹æ³•ä¸€</span></div><div class="line">- (<span class="keyword">void</span>)reset &#123;</div><div class="line">    <span class="built_in">NSNumber</span> *zero = [[<span class="built_in">NSNumber</span> alloc] initWithInteger:<span class="number">0</span>];</div><div class="line">    [<span class="keyword">self</span> setCount:zero];</div><div class="line">    [zero release];</div><div class="line">&#125;</div><div class="line"><span class="comment">// æ–¹æ³•äºŒ</span></div><div class="line">- (<span class="keyword">void</span>)reset &#123;</div><div class="line">    <span class="built_in">NSNumber</span> *zero = [[<span class="built_in">NSNumber</span> alloc] initWithInteger:<span class="number">0</span>];</div><div class="line">    [_count release];</div><div class="line">    _count = zero;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ–¹æ³•äºŒæ²¡æœ‰å¯¹<code>count</code>å±æ€§èµ‹æ–°å€¼æ—¶æ²¡æœ‰ä½¿ç”¨<code>set</code>è®¿é—®æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šè§¦å‘<code>KVO</code>ï¼Œå¯èƒ½åœ¨ç‰¹æ®Šæƒ…å†µå¯¼è‡´é”™è¯¯ï¼ˆæ¯”å¦‚å¿˜è®°äº† <code>retain</code>æˆ–è€…<code>release</code>ï¼Œæˆ–è€…å¦‚æœå®ä¾‹å˜é‡çš„å†…å­˜ç®¡ç†å‘ç”Ÿäº†å˜åŒ–ï¼‰ã€‚é™¤äº†ç¬¬ä¸€ç§æ–¹æ³•ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨<code>self.count = zero;</code>ã€‚</p>
<h4 id="ä¸è¦åœ¨åˆå§‹åŒ–å’Œdeallocä¸­ä½¿ç”¨è®¿é—®å™¨æ–¹æ³•"><a href="#ä¸è¦åœ¨åˆå§‹åŒ–å’Œdeallocä¸­ä½¿ç”¨è®¿é—®å™¨æ–¹æ³•" class="headerlink" title="ä¸è¦åœ¨åˆå§‹åŒ–å’Œdeallocä¸­ä½¿ç”¨è®¿é—®å™¨æ–¹æ³•"></a>ä¸è¦åœ¨åˆå§‹åŒ–å’Œ<code>dealloc</code>ä¸­ä½¿ç”¨è®¿é—®å™¨æ–¹æ³•</h4><p>ä¸åº”è¯¥ä½¿ç”¨<code>set</code>å’Œ<code>get</code>æ–¹æ³•åœ¨<code>init</code>å’Œ<code>dealloc</code>ã€‚åº”è¯¥ä½¿ç”¨<code>_</code>ç›´æ¥è®¿é—®æˆå‘˜å˜é‡è¿›è¡Œåˆå§‹åŒ–å’Œ<code>dealloc</code>ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- init &#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        _count = [[<span class="built_in">NSNumber</span> alloc] initWithInteger:<span class="number">0</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ç”±äºCounterç±»å…·æœ‰å¯¹è±¡å®ä¾‹å˜é‡ï¼Œå› æ­¤è¿˜å¿…é¡»å®ç°deallocæ–¹æ³•ã€‚</span></div><div class="line"><span class="comment">// å®ƒåº”è¯¥é€šè¿‡å‘ä»»ä½•å®ä¾‹å˜é‡å‘é€ä¸€ä¸ªé‡Šæ”¾æ¶ˆæ¯æ¥æ”¾å¼ƒå®ƒçš„æ‰€æœ‰æƒï¼Œæœ€ç»ˆå®ƒåº”è¯¥è°ƒç”¨superçš„å®ç°</span></div><div class="line">- (<span class="keyword">void</span>)dealloc &#123;</div><div class="line">    [_count release];</div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ä½¿ç”¨å¼±å¼•ç”¨æ¥é¿å…å¾ªç¯å¼•ç”¨"><a href="#ä½¿ç”¨å¼±å¼•ç”¨æ¥é¿å…å¾ªç¯å¼•ç”¨" class="headerlink" title="ä½¿ç”¨å¼±å¼•ç”¨æ¥é¿å…å¾ªç¯å¼•ç”¨"></a>ä½¿ç”¨å¼±å¼•ç”¨æ¥é¿å…å¾ªç¯å¼•ç”¨</h4><ul>
<li><code>retain</code>å¯¹è±¡ï¼Œå®é™…æ˜¯å¯¹å¯¹è±¡çš„å¼ºå¼•ç”¨(strong reference),ä¸€ä¸ªå¯¹è±¡åœ¨æ‰€æœ‰å¼ºå¼•ç”¨éƒ½æ²¡æœ‰è¢«é‡Šæ”¾ä¹‹å‰ï¼Œä¸èƒ½é‡Šæ”¾å¯¹è±¡ã€‚å› æ­¤ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªå¯¹è±¡äº’ç›¸æŒæœ‰å¯¹æ–¹æˆ–è€…é—´æ¥äº’ç›¸å¼•ç”¨ï¼Œä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨ã€‚è¿™æ—¶å€™å°±éœ€è¦å¼±å¼•ç”¨å¯¹æ–¹æ¥æ‰“ç ´è¿™ä¸ªå¾ªç¯ã€‚</li>
</ul>
<p>å¦‚çˆ¶äº²å¼ºå¼•ç”¨å„¿å­ï¼Œå„¿å­å¼ºå¼•ç”¨å­™å­ï¼Œé‚£ä¹ˆå€’è¿‡æ¥å­™å­åªèƒ½å¼±å¼•ç”¨å„¿å­ï¼Œå„¿å­ä¹Ÿåªèƒ½å¼±å¼•ç”¨çˆ¶äº²ã€‚<code>Cocoa</code>å»ºç«‹äº†ä¸€ä¸ªçº¦å®šï¼Œå‰¯å¯¹è±¡åº”è¯¥å¼ºå¼•ç”¨å­å¯¹è±¡ï¼Œå¹¶ä¸”å­å¯¹è±¡åº”è¯¥åªå¯¹çˆ¶å¯¹è±¡å¼±å¼•ç”¨ã€‚<br><code>Cocoa</code>ä¸­å¸¸è§çš„ä¾‹å­åŒ…æ‹¬ä»£ç†æ–¹æ³•<code>delegate</code>ï¼Œ<code>data source</code>,<code>observer</code>,<code>target</code>ç­‰ç­‰</p>
<p>å¿…é¡»å°å¿ƒå°†æ¶ˆæ¯å‘é€åˆ°æŒæœ‰åªæ˜¯ä¸€ä¸ªå¼±å¼•ç”¨çš„å¯¹è±¡ã€‚å½“å‘é€æ¶ˆæ¯ç»™ä¸€ä¸ªè¢«<code>dealloc</code>çš„å¼±å¼•ç”¨å¯¹è±¡æ—¶ï¼Œä½ çš„åº”ç”¨ç¨‹åºä¼šå´©æºƒï¼ˆè¿™æ˜¯åœ¨<code>MRR</code>æ—¶æœŸçš„ä»£ç†<code>delegate</code>ä¼šå‡ºç°ï¼Œå› ä¸ºå½“æ—¶å¯¹ä»£ç†å¼±å¼•ç”¨çš„ä¿®é¥°ç¬¦æ˜¯<code>assign</code>,<code>assign</code>å¼±å¼•ç”¨å¹¶ä¸ä¼šåœ¨å¯¹è±¡<code>dealloc</code>æ—¶ï¼ŒæŠŠå¯¹è±¡ç½®ä¸º<code>nil</code>ã€‚è€Œ<code>ARC</code>æ—¶ä»£ä½¿ç”¨<code>weak</code>åˆ™ä¼šåœ¨å¯¹è±¡<code>dealloc</code>æ—¶ç½®ä¸º<code>nil</code>ï¼‰ã€‚</p>
<h4 id="é¿å…æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡è¢«é‡Šæ”¾"><a href="#é¿å…æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡è¢«é‡Šæ”¾" class="headerlink" title="é¿å…æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡è¢«é‡Šæ”¾"></a>é¿å…æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡è¢«é‡Šæ”¾</h4><ul>
<li><code>Cocoa</code>çš„æ‰€æœ‰æƒç­–ç•¥è§„å®šæ¥æ”¶çš„å¯¹è±¡é€šå¸¸åœ¨æ•´ä¸ªè°ƒç”¨æ–¹æ³•çš„èŒƒå›´å†…ä¿è¯æœ‰æ•ˆã€‚è¿˜åº”è¯¥æ˜¯åœ¨å½“å‰æ–¹æ³•èŒƒå›´å†…ï¼Œè€Œä¸å¿…æ‹…å¿ƒå®ƒè¢«é‡Šæ”¾ã€‚å¯¹è±¡çš„<code>getter</code>æ–¹æ³•è¿”å›ä¸€ä¸ªç¼“å­˜çš„å®ä¾‹å˜é‡æˆ–è€…ä¸€ä¸ªè®¡ç®—çš„å€¼ï¼Œè¿™ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ï¼Œå¯¹è±¡åœ¨éœ€è¦çš„ä½¿ç”¨æ—¶è¿˜æ˜¯æœ‰æ•ˆçš„ã€‚</li>
<li><p>æœ‰ä¸¤ç±»ä¾‹å¤–æƒ…å†µï¼š</p>
<ul>
<li><p>å½“ä¸€ä¸ªå¯¹è±¡ä»åŸºæœ¬çš„é›†åˆç±»åˆ é™¤æ—¶</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">heisenObject = [array objectAtIndex:n];</div><div class="line">[array removeObjectAtIndex:n];</div><div class="line"><span class="comment">// heisenObject ç°åœ¨å¯èƒ½æ— æ•ˆ</span></div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>- `n`ä»é›†åˆ`array`åˆ é™¤æ—¶ä¹Ÿä¼šå‘`n`å‘é€`release`ï¼ˆè€Œä¸æ˜¯`autorelease`ï¼‰æ¶ˆæ¯ã€‚å¦‚æœ`array`é›†åˆæ—¶è¢«åˆ é™¤`n`å¯¹è±¡çš„å”¯ä¸€æ‹¥æœ‰è€…ï¼Œè¢«ç§»é™¤çš„å¯¹è±¡`n`æ˜¯ç«‹å³è¢«é‡Šæ”¾çš„ã€‚`heisenObject`å¹¶æ²¡æœ‰å¯¹`n`è¿›è¡Œ`retain`ï¼Œæ‰€ä»¥å½“`n`ä»`array`åˆ é™¤æ—¶åŒæ—¶è¢«é‡Šæ”¾ã€‚

**æ­£ç¡®çš„åšæ³•**

<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">heisenObject = [[array objectAtIndex:n] <span class="keyword">retain</span>];</div><div class="line">[array removeObjectAtIndex:n];</div><div class="line"><span class="comment">// Use heisenObject...</span></div><div class="line">[heisenObject release];</div></pre></td></tr></table></figure>

- å½“ä¸€ä¸ªçˆ¶å¯¹è±¡è¢«é‡Šæ”¾æ—¶

<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">id</span> parent = &lt;<span class="meta">#create a parent object#&gt;;</span></div><div class="line"><span class="comment">// ...</span></div><div class="line">heisenObject = [parent child] ;</div><div class="line">[parent release]; <span class="comment">// Or, for example: self.parent = nil;</span></div><div class="line"><span class="comment">// heisenObject ç°åœ¨å¯èƒ½æ— æ•ˆ</span></div></pre></td></tr></table></figure>
</code></pre><ul>
<li>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä»å¦ä¸€ä¸ªå¯¹è±¡è·å–çš„å¯¹è±¡ï¼Œç„¶åç›´æ¥æˆ–è€…é—´æ¥çš„é‡Šæ”¾è´Ÿå¯¹è±¡ã€‚å¦‚æœé‡Šæ”¾çˆ¶å¯¹è±¡å¯¼è‡´å®ƒè¢«é‡Šæ”¾ï¼Œå¹¶ä¸”çˆ¶å¯¹è±¡æ˜¯å­å¯¹è±¡å”¯ä¸€æ‰€æœ‰è€…ï¼Œé‚£ä¹ˆå­å¯¹è±¡<code>heisenObject</code>å°†è¢«åŒä¸€æ—¶é—´é‡Šæ”¾ã€‚æ‰€ä»¥æ­£ç¡®çš„åšæ³•è¿˜æ˜¯å­å¯¹è±¡<code>heisenObject</code>è·å–çš„æ—¶å€™å…ˆ<code>retain</code>ä¸€æ¬¡ã€‚</li>
</ul>
<h4 id="Collectionsç±»æ‹¥æœ‰å®ƒä»¬æ‰€åŒ…å«çš„å¯¹è±¡æ‰€æœ‰æƒ"><a href="#Collectionsç±»æ‹¥æœ‰å®ƒä»¬æ‰€åŒ…å«çš„å¯¹è±¡æ‰€æœ‰æƒ" class="headerlink" title="Collectionsç±»æ‹¥æœ‰å®ƒä»¬æ‰€åŒ…å«çš„å¯¹è±¡æ‰€æœ‰æƒ"></a>Collectionsç±»æ‹¥æœ‰å®ƒä»¬æ‰€åŒ…å«çš„å¯¹è±¡æ‰€æœ‰æƒ</h4><ul>
<li>æ·»åŠ ä¸€ä¸ªå¯¹è±¡åˆ°ä¸€ä¸ª<code>collection</code>ä¸­ï¼Œå¦‚(æ•°ç»„ã€å­—å…¸ã€é›†åˆ)æ—¶ï¼Œ<code>collection</code>ä¼šå¾—åˆ°è¯¥å¯¹è±¡æ‰€æœ‰æƒã€‚å½“å¯¹è±¡ä»<code>collection</code>åˆ é™¤æˆ–è€…<code>collection</code>è‡ªå·±è¢«é‡Šæ”¾æ—¶ï¼Œ<code>collection</code>å°†é‡Šæ”¾å®ƒæ‹¥æœ‰çš„æ‰€æœ‰æƒã€‚</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSMutableArray</span> *array = &lt;<span class="meta">#Get a mutable array#&gt;;</span></div><div class="line"><span class="built_in">NSUInteger</span> i;</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">    <span class="built_in">NSNumber</span> *allocedNumber = [[<span class="built_in">NSNumber</span> alloc] initWithInteger:i];</div><div class="line">    [array addObject:allocedNumber];</div><div class="line">    [allocedNumber release];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="é€šè¿‡å¼•ç”¨è®¡æ•°å®ç°æ‰€æœ‰æ‰€æœ‰æƒç­–ç•¥"><a href="#é€šè¿‡å¼•ç”¨è®¡æ•°å®ç°æ‰€æœ‰æ‰€æœ‰æƒç­–ç•¥" class="headerlink" title="é€šè¿‡å¼•ç”¨è®¡æ•°å®ç°æ‰€æœ‰æ‰€æœ‰æƒç­–ç•¥"></a>é€šè¿‡å¼•ç”¨è®¡æ•°å®ç°æ‰€æœ‰æ‰€æœ‰æƒç­–ç•¥</h4><ul>
<li><p>æ‰€æœ‰åœˆç­–ç•¥æ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°å®ç°çš„ï¼Œé€šå¸¸<code>retain</code>æ–¹æ³•åè¢«ç§°ä¸º<code>retain count</code>ã€‚æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°ã€‚</p>
<ul>
<li>å½“ä½ åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„å¼•ç”¨è®¡æ•°ä¸º<code>1</code></li>
<li>å½“ä½ ç»™å¯¹è±¡å‘é€<code>retain</code>æ¶ˆæ¯ï¼Œå¼•ç”¨è®¡æ•°<code>+1</code></li>
<li>å½“ä½ ç»™å¯¹è±¡å‘é€<code>release</code>æ¶ˆæ¯ï¼Œå¼•ç”¨è®¡æ•°<code>-1</code></li>
<li>å½“ä½ ç»™å¯¹è±¡å‘é€ä¸€ä¸ª<code>autorelease</code>æ¶ˆæ¯ï¼Œå®ƒçš„å¼•ç”¨è®¡æ•°å™¨å°†åœ¨å½“å‰çš„è‡ªåŠ¨é‡Šæ”¾æ± ç»“æŸå<code>-1</code></li>
<li>å½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º<code>0</code>æ—¶å°†è¢«é‡Šæ”¾</li>
</ul>
</li>
</ul>
<h2 id="ARCæ—¶ä»£"><a href="#ARCæ—¶ä»£" class="headerlink" title="# ARCæ—¶ä»£"></a># ARCæ—¶ä»£</h2><h3 id="æ¦‚è¦-1"><a href="#æ¦‚è¦-1" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h3><p>iOS5åå‡ºç°äº†<code>ARC</code>ã€‚é‚£ä¹ˆ<code>ARC</code>æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br>è‡ªåŠ¨å¼•ç”¨è®¡æ•°<code>ARC</code>æ˜¯ä¸€ç§ç¼–è¯‘å™¨çš„åŠŸèƒ½ï¼Œä¸º<code>Objective-C</code>å¯¹è±¡æä¾›äº†è‡ªåŠ¨åŒ–çš„å†…å­˜ç®¡ç†ã€‚<br>åœ¨<code>ARC</code>ä¸éœ€è¦å¼€å‘è€…è€ƒè™‘ä¿ç•™æˆ–è€…é‡Šæ”¾çš„æ“ä½œï¼Œå°±æ˜¯ä¸ç”¨è‡ªå·±æ‰‹åŠ¨<code>retain</code>ã€<code>release</code>å’Œ<code>autorelease</code>ï¼ˆğŸ˜„å¼€å¿ƒï¼‰ï¼Œè®©å¼€å‘è€…å¯ä»¥ä¸“æ³¨å†™æœ‰è¶£çš„ä»£ç ã€‚</p>
<p><strong>å½“ç„¶<code>ARC</code>ä¾ç„¶æ˜¯åŸºäºå¼•ç”¨è®¡æ•°ç®¡ç†å†…å­˜ã€‚</strong></p>
<h3 id="ARC-å¼ºåˆ¶æ–°è§„åˆ™"><a href="#ARC-å¼ºåˆ¶æ–°è§„åˆ™" class="headerlink" title="ARC å¼ºåˆ¶æ–°è§„åˆ™"></a>ARC å¼ºåˆ¶æ–°è§„åˆ™</h3><p><code>ARC</code>ç›¸å¯¹äº<code>MRR</code>å¼ºåˆ¶åŠ äº†ä¸€äº›æ–°çš„è§„åˆ™ã€‚</p>
<ul>
<li>ä½ ä¸èƒ½ä¸»åŠ¨è°ƒç”¨<code>dealloc</code>ã€æˆ–è€…è°ƒç”¨<code>retain</code>,<code>release</code>, <code>retainCount</code>,<code>autorelease</code>å°±æ˜¯è¿™äº›éƒ½ä¸ç”¨ä½ å†™äº†ã€‚ä¹Ÿä¸èƒ½<code>@selector(retain)</code>, <code>@selector(release)</code>è¿™æ ·å­è°ƒç”¨ã€‚</li>
<li>ä½ å¯ä»¥å®ç°ä¸€ä¸ª<code>dealloc</code>æ–¹æ³•ï¼Œå¦‚æœä½ éœ€è¦ç®¡ç†èµ„æºè€Œä¸æ˜¯é‡Šæ”¾å®ä¾‹å˜é‡(æ¯”å¦‚è§£é™¤ç›‘å¬ã€é‡Šæ”¾å¼•ç”¨ã€socket closeç­‰ç­‰)ã€‚åœ¨é‡å†™<code>dealloc</code>åéœ€è¦<code>[super dealloc]</code>ï¼ˆåœ¨æ‰‹åŠ¨ç®¡ç†å¼•ç”¨è®¡æ•°æ—¶æ‰éœ€è¦ï¼‰ã€‚</li>
<li>ä»ç„¶å¯ä»¥ä½¿ç”¨<code>CFRetain</code>ï¼Œ<code>CFRelease</code>ç­‰å…¶å®ƒå¯¹è±¡ã€‚</li>
<li>ä½ ä¸èƒ½ä½¿ç”¨<code>NSAllocateObject</code>æˆ–è€…<code>NSDeallocateObject</code>ã€‚</li>
<li>ä½ ä¸èƒ½ä½¿ç”¨<code>C</code>ç»“æ„ä½“ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª<code>Objective-C</code>ç±»å»ç®¡ç†æ•°æ®è€Œä¸æ˜¯ä¸€ä¸ªç»“æ„ä½“ã€‚</li>
<li><code>id</code>å’Œ<code>void</code>æ²¡æœ‰è½¬æ¢å…³ç³»,ä½ å¿…é¡»ä½¿ç”¨<code>cast</code>ç‰¹æ®Šæ–¹å¼ï¼Œä»¥ä¾¿åœ¨ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’çš„<code>Objective-C</code>å¯¹è±¡å’Œ<code>Core Foundation</code>ç±»å‹ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚</li>
<li>ä½ ä¸èƒ½ä½¿ç”¨<code>NSAutoreleasePool</code>ï¼Œä½¿ç”¨<code>@autoreleasepool</code>ã€‚</li>
<li>æ²¡å¿…è¦ä½¿ç”¨<code>NSZone</code></li>
</ul>
<h3 id="ARC-ä½¿ç”¨æ–°ä¿®é¥°ç¬¦"><a href="#ARC-ä½¿ç”¨æ–°ä¿®é¥°ç¬¦" class="headerlink" title="ARC ä½¿ç”¨æ–°ä¿®é¥°ç¬¦"></a>ARC ä½¿ç”¨æ–°ä¿®é¥°ç¬¦</h3><ul>
<li><code>__strong</code> å¼ºå¼•ç”¨,ç”¨æ¥ä¿è¯å¯¹è±¡ä¸ä¼šè¢«é‡Šæ”¾ã€‚</li>
<li><code>__weak</code>å¼±å¼•ç”¨ é‡Šæ”¾æ—¶ä¼šç½®ä¸º<code>nil</code></li>
<li><code>__unsafe_unretained</code>å¼±å¼•ç”¨ å¯èƒ½ä¸å®‰å…¨ï¼Œå› ä¸ºé‡Šæ”¾æ—¶ä¸ç½®ä¸º<code>nil</code>ã€‚</li>
<li><code>__autoreleasing</code>å¯¹è±¡è¢«æ³¨å†Œåˆ°<code>autorelease pool</code>ä¸­æ–¹æ³•åœ¨è¿”å›æ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚</li>
</ul>
<h3 id="å†…å­˜æ³„æ¼"><a href="#å†…å­˜æ³„æ¼" class="headerlink" title="å†…å­˜æ³„æ¼"></a>å†…å­˜æ³„æ¼</h3><p><code>ARC</code>è¿˜æ˜¯åŸºäºå¼•ç”¨è®¡æ•°çš„ç®¡ç†æœºåˆ¶æ‰€ä»¥ä¾ç„¶ä¼šå‡ºç°å¾ªç¯å¼•ç”¨ã€‚</p>
<h4 id="blockä½¿ç”¨ä¸­å‡ºç°å¾ªç¯å¼•ç”¨"><a href="#blockä½¿ç”¨ä¸­å‡ºç°å¾ªç¯å¼•ç”¨" class="headerlink" title="blockä½¿ç”¨ä¸­å‡ºç°å¾ªç¯å¼•ç”¨"></a>blockä½¿ç”¨ä¸­å‡ºç°å¾ªç¯å¼•ç”¨</h4><ul>
<li>å¸¸è§çš„æœ‰æƒ…å†µåœ¨<code>block</code>ä½¿ç”¨ä¸­å‡ºç°å¾ªç¯å¼•ç”¨</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æƒ…å†µä¸€</span></div><div class="line"><span class="keyword">self</span>.myBlock = ^&#123;</div><div class="line"><span class="keyword">self</span>.objc = ...;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// æƒ…å†µäºŒ</span></div><div class="line">Dog *dog = [[Dog alloc] init];</div><div class="line">dog.myBlock = ^&#123;</div><div class="line">	 <span class="comment">// do something</span></div><div class="line">&#125;;</div><div class="line"><span class="keyword">self</span>.dog = dog;</div></pre></td></tr></table></figure>
<pre><code>- è§£å†³æ–¹æ³•

<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span> (<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</div><div class="line"><span class="keyword">self</span>.myBlock = ^&#123;</div><div class="line">weakSelf.objc = ...;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</code></pre><ul>
<li><p>é‚£ä¹ˆå¦‚æœ<code>block</code>å†…ä½¿ç”¨äº†<code>self</code>è¿™ä¸ªæ—¶å€™å¦‚æœæŸä¸€ä¸ªæ—¶åˆ»<code>self</code>è¢«é‡Šæ”¾å°±ä¼šå¯¼è‡´å‡ºç°é—®é¢˜ã€‚</p>
</li>
<li><p>è§£å†³æ–¹æ³•</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span> (<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</div><div class="line"><span class="keyword">self</span>.myBlock = ^&#123;</div><div class="line">__<span class="keyword">strong</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) strongSelf = weakSelf;</div><div class="line">strongSelf.objc1 = ...;</div><div class="line">strongSelf.objc2 = ...;</div><div class="line">strongSelf.objc3 = ...;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>__weak</code>æ‰“ç ´å¾ªç¯å¼•ç”¨ã€‚<code>__strong</code>ç”¨æ¥é¿å…åœ¨ä½¿ç”¨<code>self</code>è¿‡ç¨‹ä¸­<code>self</code>è¢«é‡Šæ”¾ï¼Œ<code>__strong</code>åœ¨<code>block</code>åä¼šè°ƒç”¨<code>objc_release(obj)</code>é‡Šæ”¾å¯¹è±¡ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">id</span> __<span class="keyword">strong</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">	</div><div class="line"><span class="comment">// clang ç¼–è¯‘å</span></div><div class="line"><span class="keyword">id</span> obj = objc_msgSend(<span class="built_in">NSObject</span>, <span class="keyword">@selector</span>(alloc));</div><div class="line">objc_msgSend(obj, <span class="keyword">@selector</span>(init));</div><div class="line">objc_release(obj);</div></pre></td></tr></table></figure>
<p>ä¸¤æ¬¡è°ƒç”¨<code>objc_msgSend</code>å¹¶åœ¨å˜é‡ä½œç”¨åŸŸç»“æŸæ—¶è°ƒç”¨<code>objc_release</code>é‡Šæ”¾å¯¹è±¡ï¼Œä¸ä¼šå‡ºç°å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚</p>
<h4 id="NSTimerå¾ªç¯å¼•ç”¨"><a href="#NSTimerå¾ªç¯å¼•ç”¨" class="headerlink" title="NSTimerå¾ªç¯å¼•ç”¨"></a>NSTimerå¾ªç¯å¼•ç”¨</h4><p>ä¸ºä»€ä¹ˆ<code>NSTimer</code>ä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨å‘¢ï¼Ÿ</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">NSTimer</span> *)timerWithTimeInterval:(<span class="built_in">NSTimeInterval</span>)ti </div><div class="line">									  target:(<span class="keyword">id</span>)aTarget </div><div class="line">									  selector:(SEL)aSelector </div><div class="line">									  userInfo:(<span class="keyword">nullable</span> <span class="keyword">id</span>)userInfo </div><div class="line">									  repeats:(<span class="built_in">BOOL</span>)yesOrNo;</div><div class="line">									  </div><div class="line">									  </div><div class="line">+ (<span class="built_in">NSTimer</span> *)scheduledTimerWithTimeInterval:(<span class="built_in">NSTimeInterval</span>)ti </div><div class="line">										        target:(<span class="keyword">id</span>)aTarget </div><div class="line">										        selector:(SEL)aSelector </div><div class="line">										        userInfo:(<span class="keyword">nullable</span> <span class="keyword">id</span>)userInfo </div><div class="line">										        repeats:(<span class="built_in">BOOL</span>)yesOrNo;</div></pre></td></tr></table></figure>
<ul>
<li><p>ä¸»è¦æ˜¯å› ä¸º<code>NSRunloop</code>è¿è¡Œå¾ªç¯ä¿æŒäº†å¯¹<code>NSTimer</code>çš„å¼ºå¼•ç”¨ï¼Œå¹¶ä¸”<code>NSTimer</code>çš„<code>targer</code>ä¹Ÿä½¿ç”¨äº†å¼ºå¼•ç”¨ã€‚</p>
</li>
<li><p>æ¥è‡ªæ–‡æ¡£<a href="https://developer.apple.com/reference/foundation/nstimer?language=objc" target="_blank" rel="external">NSTimer</a></p>
</li>
</ul>
<blockquote>
<p>Note in particular that run loops maintain strong references to their timers, so you donâ€™t have to maintain your own strong reference to a timer after you have added it to a run loop.<br><strong>target</strong><br>The object to which to send the message specified by aSelector when the timer fires. The timer maintains a strong reference to this object until it (the timer) is invalidated.</p>
</blockquote>
<p>ä¸¾ä¸ªğŸŒ°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()&lt;<span class="title">viewControllerDelegate</span>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSTimer</span> *timer;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"> - (<span class="keyword">void</span>)viewDidLoad</div><div class="line"> &#123;</div><div class="line">     [<span class="keyword">super</span> viewDidLoad];</div><div class="line">     <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1</span></div><div class="line">                                               target:<span class="keyword">self</span> </div><div class="line">                                             selector:<span class="keyword">@selector</span>(onTimeOut:) </div><div class="line">                                             userInfo:<span class="literal">nil</span> </div><div class="line">                                              repeats:<span class="literal">NO</span>];</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œæ§åˆ¶å™¨å¼ºå¼•ç”¨äº†<code>timer</code>ï¼Œè€Œ<code>timer</code>ä¹Ÿå¼ºå¼•ç”¨äº†æ§åˆ¶å™¨,è¿™ä¸ªæ—¶å€™å°±æ˜¯å¾ªç¯å¼•ç”¨äº†ï¼Œå¼•ç”¨å…³ç³»å¦‚ä¸‹å›¾ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">timer-&gt;æ§åˆ¶å™¨:strong</div><div class="line">æ§åˆ¶å™¨-&gt;timer:strong</div></pre></td></tr></table></figure>
<ul>
<li>é‚£ä¹ˆå¦‚æœæ§åˆ¶å™¨å¯¹<code>timer</code>ä½¿ç”¨äº†<code>weak</code>å‘¢ï¼Ÿ<br>ä½¿ç”¨<code>weak</code>æ˜¯æ‰“ç ´äº†å¾ªç¯å¼•ç”¨,ä½†æ˜¯<code>run loop</code>è¿˜æ˜¯å¼ºå¼•ç”¨ç€<code>timer</code>,<code>timer</code>åˆå¼ºå¼•ç”¨ç€æ§åˆ¶å™¨ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚å¼•ç”¨å…³ç³»å¦‚ä¸‹å›¾ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">runloop-&gt;timer:strong</div><div class="line">timer-&gt;æ§åˆ¶å™¨:strong</div><div class="line">æ§åˆ¶å™¨--&gt;timer:weak</div></pre></td></tr></table></figure>
<p>å¦‚æœæˆ‘ä»¬æŠŠ<code>timer</code>åŠ å…¥ä¸»çº¿ç¨‹çš„<code>runloop</code>,ä¸»çº¿ç¨‹ä¸­çš„<code>runloop</code>ç”Ÿå‘½å‘¨æœŸåªæœ‰ä¸»çº¿ç¨‹ç»“æŸæ‰ä¼šé”€æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä¸»åŠ¨è°ƒç”¨<code>[timer invalidate]</code>,<code>runloop</code>ä¼šä¸€ç›´æŒæœ‰<code>timer</code>ï¼Œ<code>timer</code>åˆæŒæœ‰æ§åˆ¶å™¨ï¼Œé‚£ä¹ˆå°±ä¸€ç›´ä¸ä¼šé‡Šæ”¾æ§åˆ¶å™¨ã€‚</p>
<ul>
<li>è§£å†³æ–¹æ³•ï¼šæ‰‹åŠ¨è°ƒç”¨<code>[timer invalidate]</code>æ¥è§£é™¤æŒæœ‰å…³ç³»ï¼Œé‡Šæ”¾å†…å­˜ã€‚å¯èƒ½ä¼šæƒ³åˆ°åœ¨<code>dealloc</code>æ–¹æ³•ä¸­æ¥æ‰‹åŠ¨è°ƒç”¨ï¼Œä½†æ˜¯å› ä¸º<code>timer</code>æŒæœ‰æ§åˆ¶å™¨ï¼Œæ‰€ä»¥æ§åˆ¶å™¨çš„<code>dealloc</code>æ–¹æ³•æ°¸è¿œä¸ä¼šè°ƒç”¨ï¼Œå› ä¸º<code>dealloc</code>æ˜¯åœ¨æ§åˆ¶å™¨è¦è¢«é‡Šæ”¾å‰è°ƒç”¨çš„ã€‚åœ¨<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Timers/Articles/usingTimers.html" target="_blank" rel="external">Timer Programming Topics</a>ä¸­æœ‰ç‰¹åˆ«è¯´æ˜ã€‚æ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬å¯ä»¥åœ¨ä¸‹é¢è¿™äº›æ–¹æ³•ä¸­æ‰‹åŠ¨è°ƒç”¨<code>[timer invalidate]</code>ç„¶åç½®ä¸º<code>nil</code>ï¼š</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewWillDisappear:(<span class="built_in">BOOL</span>)animated; <span class="comment">// Called when the view is dismissed, covered or otherwise hidden. Default does nothing</span></div><div class="line">- (<span class="keyword">void</span>)viewDidDisappear:(<span class="built_in">BOOL</span>)animated;  <span class="comment">// Called after the view was dismissed, covered or otherwise hidden. Default does nothing</span></div></pre></td></tr></table></figure>
<blockquote>
<p>A timer maintains a strong reference to its target. This means that as long as a timer remains valid, its target will not be deallocated. As a corollary, this means that it does not make sense for a timerâ€™s target to try to invalidate the timer in its dealloc methodâ€”the dealloc method will not be invoked as long as the timer is valid.</p>
</blockquote>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="# å‚è€ƒèµ„æ–™"></a># å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/MemoryMgmt.html#//apple_ref/doc/uid/10000011-SW1" target="_blank" rel="external">About Memory Management</a></li>
<li><a href="https://developer.apple.com/library/content/releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html" target="_blank" rel="external">Transitioning to ARC Release Notes</a></li>
<li><a href="https://developer.apple.com/reference/foundation/nstimer?language=objc" target="_blank" rel="external">NSTimer</a></li>
<li><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Timers/Articles/usingTimers.html" target="_blank" rel="external">Timer Programming Topics</a></li>
<li><a href="https://book.douban.com/subject/25829244/" target="_blank" rel="external">ã€ŠEffective Objective-C 2.0 ç¼–å†™é«˜è´¨é‡iOSä¸OS Xä»£ç çš„52ä¸ªæœ‰æ•ˆæ–¹æ³•ã€‹</a></li>
<li><a href="https://book.douban.com/subject/24720270/" target="_blank" rel="external">ã€Šobjcé«˜çº§ç¼–ç¨‹:iOSä¸OS Xå¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†ã€‹</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2017/02/16/2017-2-16-iOS-Gradient-Switch/" class="prev">PREV</a><a href="/2016/12/21/NSNotificationCenterå®ç°åŸç†ï¼Ÿ/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'gwrcode';
var disqus_identifier = '2016/12/29/iOS-Memory-management/';
var disqus_title = 'iOS Memory management';
var disqus_url = 'https://github.com/VeinGuo/2016/12/29/iOS-Memory-management/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//gwrcode.disqus.com/count.js" async></script><div class="copyright"><p>Â© 2016 - 2017 <a href="https://github.com/VeinGuo">Vein</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-90661596-1",'auto');ga('send','pageview');</script></body></html>